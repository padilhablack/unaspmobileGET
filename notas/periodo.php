<?php

include '../classes/Database.php';
//
//$raGET = 86539 ;
//$cursoGet = 800;

$raGET = $_GET['ra'] ;
$cursoGet = $_GET['curso'];

$result = array('erro' => false);

$sql = mssql_query("SELECT DISTINCT PLCMCA.ANO_LETIVO, supervisor.PERIODO.DES_PERIODO, PLCMCA.COD_PERIODO AS CURSOANOPERIODO,         CONVERT(CHAR(4),PLCMCA.ANO_LETIVO) + ' - ' + RTRIM(LTRIM(DES_PERIODO)) AS ANODESPERIODO  FROM (SELECT DISTINCT supervisor.MATRIZ_CURRICULAR.COD_CURSO, supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO, supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO        FROM supervisor.GRADE INNER JOIN  	   supervisor.ALUNO_X_DISCIPLINA ON supervisor.GRADE.COD_TURMA = supervisor.ALUNO_X_DISCIPLINA.COD_TURMA AND   	   supervisor.GRADE.COD_DISCIPLINA = supervisor.ALUNO_X_DISCIPLINA.COD_DISCIPLINA AND   	   supervisor.GRADE.COD_PESSOA = supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA_PROFES AND   	   supervisor.GRADE.ANO_LETIVO = supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO AND   	   supervisor.GRADE.COD_PERIODO = supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO INNER JOIN  	   supervisor.ALUNO_X_MATRIZ_CURRICULAR ON   	   supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_PESSOA AND   	   supervisor.GRADE.COD_MATRIZ_CURRICULAR = supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR INNER JOIN  	   supervisor.MATRIZ_CURRICULAR ON   	   supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR AND             supervisor.MATRIZ_CURRICULAR.COD_CURSO = '".$cursoGet."'      WHERE (supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = ".$raGET." )  UNION           SELECT DISTINCT supervisor.MATRIZ_CURRICULAR.COD_CURSO, supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO, supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO        FROM supervisor.GRADE INNER JOIN  	   supervisor.MATRIZ_DISCIPLINA_OFERTADA ON   	   supervisor.GRADE.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_MATRIZ_CURRICULAR AND   	   supervisor.GRADE.COD_ETAPA = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_ETAPA AND   	   supervisor.GRADE.COD_DISCIPLINA = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_DISCIPLINA_OFERTADA INNER JOIN  	   supervisor.MATRIZ_CURRICULAR_DISCIPLINA ON   	   supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_MATRIZ_CURRICULAR AND   	   supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_ETAPA = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_ETAPA AND   	   supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_DISCIPLINA_MATRIZ = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_DISCIPLINA INNER JOIN  	   supervisor.ALUNO_X_DISCIPLINA ON supervisor.GRADE.COD_TURMA = supervisor.ALUNO_X_DISCIPLINA.COD_TURMA AND   	   supervisor.GRADE.COD_DISCIPLINA = supervisor.ALUNO_X_DISCIPLINA.COD_DISCIPLINA AND   	   supervisor.GRADE.COD_PESSOA = supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA_PROFES AND   	   supervisor.GRADE.ANO_LETIVO = supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO AND   	   supervisor.GRADE.COD_PERIODO = supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO INNER JOIN  	   supervisor.ALUNO_X_MATRIZ_CURRICULAR ON   	   supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_PESSOA INNER JOIN  	   supervisor.MATRIZ_CURRICULAR ON   	   supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR AND             supervisor.MATRIZ_CURRICULAR.COD_CURSO = '".$cursoGet."' INNER JOIN  	   supervisor.MATRIZ_EQUIVALENCIA ON   	   supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_EQUIVALENCIA.COD_MATRIZ_PRINCIPAL AND   	   supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_EQUIVALENCIA.COD_MATRIZ_EQUIVALENTE AND   	   supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_ETAPA = supervisor.MATRIZ_EQUIVALENCIA.COD_ETAPA_EQUIVALENTE AND   	   supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_DISCIPLINA = supervisor.MATRIZ_EQUIVALENCIA.COD_DISCIPLINA_EQUIVALENTE        WHERE (supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = ".$raGET." )  UNION        SELECT DISTINCT supervisor.MATRIZ_CURRICULAR.COD_CURSO, supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO, supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO        FROM supervisor.GRADE INNER JOIN             supervisor.MATRIZ_DISCIPLINA_OFERTADA ON              supervisor.GRADE.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_MATRIZ_CURRICULAR AND              supervisor.GRADE.COD_ETAPA = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_ETAPA AND              supervisor.GRADE.COD_DISCIPLINA = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_DISCIPLINA_OFERTADA INNER JOIN             supervisor.MATRIZ_CURRICULAR_DISCIPLINA ON              supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_MATRIZ_CURRICULAR AND             supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_ETAPA = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_ETAPA AND              supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_DISCIPLINA_MATRIZ = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_DISCIPLINA INNER JOIN             supervisor.ALUNO_X_DISCIPLINA ON supervisor.GRADE.COD_TURMA = supervisor.ALUNO_X_DISCIPLINA.COD_TURMA AND              supervisor.GRADE.COD_DISCIPLINA = supervisor.ALUNO_X_DISCIPLINA.COD_DISCIPLINA AND              supervisor.GRADE.COD_PESSOA = supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA_PROFES AND              supervisor.GRADE.ANO_LETIVO = supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO AND              supervisor.GRADE.COD_PERIODO = supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO INNER JOIN             supervisor.ALUNO_X_MATRIZ_CURRICULAR ON              supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_PESSOA INNER JOIN             supervisor.MATRIZ_CURRICULAR ON              supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR AND             supervisor.MATRIZ_CURRICULAR.COD_CURSO = '".$cursoGet."' INNER JOIN             supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL ON              supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL.COD_MATRIZ_PRINCIPAL AND              supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_PESSOA = supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL.COD_PESSOA AND             supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL.COD_MATRIZ_EQUIVALENTE AND              supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_ETAPA = supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL.COD_ETAPA_EQUIVALENTE AND              supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_DISCIPLINA = supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL.COD_DISCIPLINA_EQUIVALENTE         WHERE (supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = ".$raGET." )) PLCMCA INNER JOIN        supervisor.PERIODO ON PLCMCA.COD_PERIODO = supervisor.PERIODO.COD_PERIODO   ORDER BY PLCMCA.ANO_LETIVO DESC, DES_PERIODO");

$periodos = array();

while ($row = @mssql_fetch_assoc($sql)) {
    $periodos[] = array(
        'ANO_LETIVO' => $row['ANO_LETIVO'],
        'DES_PERIODO' => $row['DES_PERIODO'],
        'CURSOANOPERIODO' => $row['CURSOANOPERIODO'],
        'ANODESPERIODO' => $row['ANODESPERIODO']
    );
}

for ($i = 0; $i < count($periodos); $i++) {
    $mostrar = array(
        'ANO_LETIVO' => $periodos[$i]['ANO_LETIVO'],
        'DES_PERIODO' => $periodos[$i]['$DES_PERIODO'],
        'CURSOANOPERIODO' => $periodos[$i]['CURSOANOPERIODO'],
        'ANODESPERIODO' => $periodos[$i]['ANODESPERIODO'],
    );

    $encodedArray = array_map(utf8_encode, $mostrar);
    echo(json_encode($encodedArray) . '</br>');
}
?>