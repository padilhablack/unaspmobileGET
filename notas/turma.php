<?php

include '../classes/Database.php';


//$raGET = 86539;
//$cursoGet = 800;
//$anoGet = 2014;
//$periodoGet = 1;

$raGET = $_GET['ra'] ;
$cursoGet = $_GET['curso'];
$anoGet = $_GET['ano'] ;
$periodoGet = $_GET['periodo'];


$sql = mssql_query("SELECT DISTINCT PLCMCA.ANO_LETIVO, PLCMCA.COD_PERIODO, PLCMCA.COD_TURMA,    RTRIM(LTRIM(PLCMCA.COD_TURMA)) + ' - ' + RTRIM(LTRIM(supervisor.TURMA.DES_TURMA)) AS TURMA,    PLCMCA.COD_TURMA AS CURANOPERTURMA  FROM (SELECT DISTINCT supervisor.MATRIZ_CURRICULAR.COD_CURSO, supervisor.ALUNO_X_DISCIPLINA.COD_TURMA, supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO, supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO        FROM supervisor.GRADE INNER JOIN     supervisor.ALUNO_X_DISCIPLINA ON supervisor.GRADE.COD_TURMA = supervisor.ALUNO_X_DISCIPLINA.COD_TURMA AND      supervisor.GRADE.COD_DISCIPLINA = supervisor.ALUNO_X_DISCIPLINA.COD_DISCIPLINA AND      supervisor.GRADE.COD_PESSOA = supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA_PROFES AND      supervisor.GRADE.ANO_LETIVO = supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO AND      supervisor.GRADE.COD_PERIODO = supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO INNER JOIN     supervisor.ALUNO_X_MATRIZ_CURRICULAR ON      supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_PESSOA AND      supervisor.GRADE.COD_MATRIZ_CURRICULAR = supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR INNER JOIN     supervisor.MATRIZ_CURRICULAR ON      supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR AND             supervisor.MATRIZ_CURRICULAR.COD_CURSO = '" . $cursoGet . "'        WHERE (supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = " . $raGET . " )          AND (supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO = " . $anoGet . " )          AND (supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO = " . $periodoGet . " )  UNION           SELECT DISTINCT supervisor.MATRIZ_CURRICULAR.COD_CURSO, supervisor.ALUNO_X_DISCIPLINA.COD_TURMA, supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO, supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO        FROM supervisor.GRADE INNER JOIN     supervisor.MATRIZ_DISCIPLINA_OFERTADA ON      supervisor.GRADE.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_MATRIZ_CURRICULAR AND      supervisor.GRADE.COD_ETAPA = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_ETAPA AND      supervisor.GRADE.COD_DISCIPLINA = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_DISCIPLINA_OFERTADA INNER JOIN     supervisor.MATRIZ_CURRICULAR_DISCIPLINA ON      supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_MATRIZ_CURRICULAR AND      supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_ETAPA = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_ETAPA AND      supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_DISCIPLINA_MATRIZ = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_DISCIPLINA INNER JOIN     supervisor.ALUNO_X_DISCIPLINA ON supervisor.GRADE.COD_TURMA = supervisor.ALUNO_X_DISCIPLINA.COD_TURMA AND      supervisor.GRADE.COD_DISCIPLINA = supervisor.ALUNO_X_DISCIPLINA.COD_DISCIPLINA AND      supervisor.GRADE.COD_PESSOA = supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA_PROFES AND      supervisor.GRADE.ANO_LETIVO = supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO AND      supervisor.GRADE.COD_PERIODO = supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO INNER JOIN     supervisor.ALUNO_X_MATRIZ_CURRICULAR ON      supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_PESSOA INNER JOIN     supervisor.MATRIZ_CURRICULAR ON      supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR AND             supervisor.MATRIZ_CURRICULAR.COD_CURSO = '" . $cursoGet . "' INNER JOIN     supervisor.MATRIZ_EQUIVALENCIA ON      supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_EQUIVALENCIA.COD_MATRIZ_PRINCIPAL AND      supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_EQUIVALENCIA.COD_MATRIZ_EQUIVALENTE AND      supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_ETAPA = supervisor.MATRIZ_EQUIVALENCIA.COD_ETAPA_EQUIVALENTE AND      supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_DISCIPLINA = supervisor.MATRIZ_EQUIVALENCIA.COD_DISCIPLINA_EQUIVALENTE        WHERE (supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = " . $raGET . " )          AND (supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO = " . $anoGet . " )          AND (supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO = " . $periodoGet . " )  UNION        SELECT DISTINCT supervisor.MATRIZ_CURRICULAR.COD_CURSO, supervisor.ALUNO_X_DISCIPLINA.COD_TURMA, supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO, supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO  FROM supervisor.GRADE INNER JOIN             supervisor.MATRIZ_DISCIPLINA_OFERTADA ON              supervisor.GRADE.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_MATRIZ_CURRICULAR AND              supervisor.GRADE.COD_ETAPA = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_ETAPA AND              supervisor.GRADE.COD_DISCIPLINA = supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_DISCIPLINA_OFERTADA INNER JOIN             supervisor.MATRIZ_CURRICULAR_DISCIPLINA ON              supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_MATRIZ_CURRICULAR AND             supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_ETAPA = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_ETAPA AND              supervisor.MATRIZ_DISCIPLINA_OFERTADA.COD_DISCIPLINA_MATRIZ = supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_DISCIPLINA INNER JOIN             supervisor.ALUNO_X_DISCIPLINA ON supervisor.GRADE.COD_TURMA = supervisor.ALUNO_X_DISCIPLINA.COD_TURMA AND              supervisor.GRADE.COD_DISCIPLINA = supervisor.ALUNO_X_DISCIPLINA.COD_DISCIPLINA AND              supervisor.GRADE.COD_PESSOA = supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA_PROFES AND              supervisor.GRADE.ANO_LETIVO = supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO AND              supervisor.GRADE.COD_PERIODO = supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO INNER JOIN             supervisor.ALUNO_X_MATRIZ_CURRICULAR ON              supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_PESSOA INNER JOIN             supervisor.MATRIZ_CURRICULAR ON              supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR AND             supervisor.MATRIZ_CURRICULAR.COD_CURSO = '" . $cursoGet . "' INNER JOIN             supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL ON              supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL.COD_MATRIZ_PRINCIPAL AND              supervisor.ALUNO_X_MATRIZ_CURRICULAR.COD_PESSOA = supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL.COD_PESSOA AND             supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_MATRIZ_CURRICULAR = supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL.COD_MATRIZ_EQUIVALENTE AND              supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_ETAPA = supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL.COD_ETAPA_EQUIVALENTE AND              supervisor.MATRIZ_CURRICULAR_DISCIPLINA.COD_DISCIPLINA = supervisor.MATRIZ_EQUIVALENCIA_INDIVIDUAL.COD_DISCIPLINA_EQUIVALENTE  WHERE (supervisor.ALUNO_X_DISCIPLINA.COD_PESSOA = " . $raGET . " )          AND (supervisor.ALUNO_X_DISCIPLINA.ANO_LETIVO = " . $anoGet . " )          AND (supervisor.ALUNO_X_DISCIPLINA.COD_PERIODO = " . $periodoGet . " )) PLCMCA INNER JOIN        supervisor.TURMA ON supervisor.TURMA.COD_TURMA = PLCMCA.COD_TURMA  ORDER BY TURMA");
$turma = array();

while ($row = @mssql_fetch_assoc($sql)) {
    $turma[] = $row;
}
for ($i = 0; $i < count($turma); $i++) {
    $mostrar = array(
        'ANO_LETIVO' => $turma[$i]['ANO_LETIVO'],
        'COD_PERIODO' => $turma[$i]['COD_PERIODO'],
        'COD_TURMA' => $turma[$i]['COD_TURMA'],
        'DESCRICAO' => $turma[$i]['TURMA'],
        'NOMETURMA' => $turma[$i]['CURANOPERTURMA'],
    );
    $encodedArray = array_map(utf8_encode, $mostrar);
    echo(json_encode($encodedArray) . '</br>');
}
?>